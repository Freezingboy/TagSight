# 文件标签管理系统接口文档

## 一、接口概述

本文档基于`tag_sight`数据库设计，提供用户、标签、文件及文件标签关联的全流程接口规范。系统采用RESTful设计风格，所有接口均需通过用户认证，并严格验证数据归属权。数据库包含4个核心表：`user`（用户）、`tag`（标签）、`file`（文件）和`file_tag_relation`（文件标签关联），通过`user_id`字段实现数据隔离，确保用户仅能操作自己的资源。

## 二、基础信息

### 基础URL
所有接口统一前缀：`/api/v1`

### 请求头规范
| 参数名 | 类型 | 必选 | 描述 |
|--------|------|------|------|
| Authorization | String | 是 | Bearer Token格式，如：`Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` |
| Content-Type | String | 是 | 固定为`application/json` |

### 响应格式规范
所有接口返回统一JSON格式：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {}
}
```
- **code**：状态码（200成功，4xx客户端错误，5xx服务端错误）
- **message**：结果描述
- **data**：业务数据（成功时返回，失败时可能为null）

## 三、用户接口

### 1. 用户注册
- **路径**：`/users/register`
- **方法**：POST
- **请求体**：
```json
{
  "username": "johndoe",
  "password": "Secure@123"
}
```
- **响应示例**：
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "id": 1,
    "username": "johndoe",
    "createTime": "2025-08-08T09:47:42Z"
  }
}
```
- **约束**：`username`长度1-50字符，`password`需加密存储（接口接收明文，服务端处理加密）

### 2. 用户登录
- **路径**：`/users/login`
- **方法**：POST
- **请求体**：
```json
{
  "username": "johndoe",
  "password": "Secure@123"
}
```
- **响应示例**：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "username": "johndoe"
    }
  }
}
```

## 四、标签接口

### 1. 创建标签
- **路径**：`/tags`
- **方法**：POST
- **请求体**：
```json
{
  "name": "工作",
  "color": "#FF0000"
}
```
- **响应示例**：
```json
{
  "code": 200,
  "message": "标签创建成功",
  "data": {
    "id": 1,
    "userId": 1,
    "name": "工作",
    "color": "#FF0000"
  }
}
```
- **约束**：同一用户的标签名唯一（由`idx_user_tag`索引保证）

### 2. 获取用户标签列表
- **路径**：`/tags`
- **方法**：GET
- **响应示例**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "id": 1,
      "name": "工作",
      "color": "#FF0000"
    },
    {
      "id": 2,
      "name": "重要",
      "color": "#00FF00"
    }
  ]
}
```

### 3. 更新标签
- **路径**：`/tags/{tagId}`
- **方法**：PUT
- **路径参数**：`tagId`（标签ID）
- **请求体**：
```json
{
  "name": "项目文档",
  "color": "#0000FF"
}
```
- **响应示例**：
```json
{
  "code": 200,
  "message": "标签更新成功",
  "data": {
    "id": 1,
    "name": "项目文档",
    "color": "#0000FF"
  }
}
```

### 4. 删除标签
- **路径**：`/tags/{tagId}`
- **方法**：DELETE
- **路径参数**：`tagId`（标签ID）
- **响应示例**：
```json
{
  "code": 200,
  "message": "标签删除成功",
  "data": null
}
```

## 五、文件接口

### 1. 上传文件
- **路径**：`/files/upload`
- **方法**：POST
- **请求体**：`multipart/form-data`格式，包含文件流
- **form-data** 的方式提交参数, key为`files`可以提交多个文件
- **响应示例**：
```json
{
  "code": 200,
  "message": "文件上传成功",
  "data": [
    {
      "id": 5,
      "name": "数据格式(4).txt",
      "size": 6692,
      "type": "txt",
      "path": "\\static\\0\\1754636372720508800_数据格式(4).txt",
      "uploadTime": "2025-08-08T14:59:32.7393237+08:00"
    },
    {
      "id": 6,
      "name": "数据格式(3).txt",
      "size": 3920,
      "type": "txt",
      "path": "\\static\\0\\1754636372743953400_数据格式(3).txt",
      "uploadTime": "2025-08-08T14:59:32.7439534+08:00"
    }
  ]
}
```
- **约束**：文件路径通过`idx_path`索引保证全局唯一

### 2. 获取文件列表
- **路径**：`/files`
- **方法**：GET
- **查询参数**：
  - `page`（页码，默认1）
  - `size`（每页条数，默认20）
  - `tagId`（可选，按标签筛选）
- **响应示例**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total": 2,
    "list": [
      {
        "id": 5,
        "name": "数据格式(4).txt",
        "size": 6692,
        "type": "txt",
        "uploadTime": "2025-08-08T14:59:33+08:00"
      },
      {
        "id": 6,
        "name": "数据格式(3).txt",
        "size": 3920,
        "type": "txt",
        "uploadTime": "2025-08-08T14:59:33+08:00"
      }
    ]
  }
}
```

### 3. 下载文件
- **路径**：`/files/{fileId}/download`
- **方法**：GET
- **路径参数**：`fileId`（文件ID）
- **响应**：返回文件二进制流，响应头包含`Content-Disposition: attachment; filename="report.pdf"`

### 4. 删除文件
- **路径**：`/files/{fileId}`
- **方法**：DELETE
- **路径参数**：`fileId`（文件ID）
- **响应示例**：
```json
{
  "code": 200,
  "message": "文件删除成功",
  "data": null
}
```

## 六、文件标签关联接口

### 1. 为文件添加标签
- **路径**：`/file-tags`
- **方法**：POST
- **请求体**：
```json
{
  "fileId": 1,
  "tagId": 1
}
```
- **响应示例**：
```json
{
  "code": 200,
  "message": "标签添加成功",
  "data": {
    "id": 1,
    "fileId": 1,
    "tagId": 1
  }
}
```
- **约束**：同一用户的文件-标签关联唯一（由`idx_user_file_tag`索引保证）

### 2. 从文件移除标签
- **路径**：`/file-tags`
- **方法**：DELETE
- **请求体**：
```json
{
  "fileId": 1,
  "tagId": 1
}
```
- **响应示例**：
```json
{
  "code": 200,
  "message": "标签移除成功",
  "data": null
}
```

### 3. 获取文件的标签列表
- **路径**：`/files/{fileId}/tags`
- **方法**：GET
- **路径参数**：`fileId`（文件ID）
- **响应示例**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "id": 1,
      "name": "工作",
      "color": "#FF0000"
    }
  ]
}
```

## 七、错误码说明

| 状态码 | 描述 | 典型场景 |
|--------|------|----------|
| 200 | 成功 | 所有正常操作 |
| 400 | 参数错误 | 请求参数格式错误或缺失 |
| 401 | 未授权 | Token无效或过期 |
| 403 | 权限拒绝 | 操作他人资源 |
| 404 | 资源不存在 | 请求的文件/标签不存在 |
| 409 | 冲突 | 创建重复标签名、重复文件路径 |
| 500 | 服务器错误 | 服务端异常 |

## 八、数据安全说明

所有接口通过`user_id`字段强制验证数据归属权，确保：
1. 用户只能查询/操作自己创建的标签
2. 用户只能上传/访问自己的文件
3. 文件-标签关联必须属于同一用户

数据库层面通过唯一索引（如`idx_username`、`idx_path`、`idx_user_tag`）防止重复数据，通过外键约束（隐含业务逻辑）维护数据完整性。